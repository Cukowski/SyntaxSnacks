<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SyntaxSnacks</title>
    <link rel="icon" href="{{ url_for('static', filename='images/logo.png') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/templatemo-glossy-touch.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/custom.css') }}" />
  </head>
  <body>

    <!-- Navbar -->
    <nav class="navbar">
      <div class="nav-inner">
        <div class="brand">
          <a class="brand-link" href="{{ url_for('index') }}">
            <img class="logo" src="{{ url_for('static', filename='images/logo.png') }}" alt="SyntaxSnacks logo" />
            <span>SyntaxSnacks</span>
          </a>
        </div>

        <!-- Mobile hamburger -->
        <button class="menu-toggle" aria-label="Toggle menu" aria-expanded="false" onclick="toggleMenu()">
          <span></span><span></span><span></span>
        </button>

        <!-- Links -->
        <div id="nav-links" class="links">
          <a href="{{ url_for('index') }}" class="{{ 'active' if request.endpoint=='index' else '' }}">Home</a>
          <a href="{{ url_for('dashboard') }}" class="{{ 'active' if request.endpoint=='dashboard' else '' }}">Challenges</a>
          <a href="{{ url_for('dungeons_list') }}" class="{{ 'active' if request.endpoint in ['dungeons_list', 'dungeon_view'] else '' }}">Explorer</a>
          <a href="{{ url_for('puzzles_hub') }}" class="{{ 'active' if request.endpoint.startswith('puzzle') else '' }}">Puzzles</a>
          <a href="{{ url_for('leaderboard') }}" class="{{ 'active' if request.endpoint=='leaderboard' else '' }}">Leaderboard</a>
          <a href="{{ url_for('about') }}" class="{{ 'active' if request.endpoint=='about' else '' }}">About</a>
          <a href="{{ url_for('contact') }}" class="{{ 'active' if request.endpoint=='contact' else '' }}">Contact</a>

          {% if current_user.is_authenticated %}
            {% if current_user.is_admin %}
              <div class="admin-menu" id="admin-menu">
                <button class="btn" type="button" onclick="toggleAdminMenu()" aria-expanded="false">Admin ▾</button>
                <div id="admin-menu-panel" class="admin-menu__panel">
                  <a href="{{ url_for('admin_challenges') }}">Challenges</a>
                  <a href="{{ url_for('admin_users') }}">Users</a>
                  <a href="{{ url_for('admin_messages') }}">Inbox</a>
                  <a href="{{ url_for('admin_fun_cards') }}">Fun Cards</a>
                </div>
              </div>
            {% endif %}
            <a href="{{ url_for('logout') }}">Logout</a>
          {% else %}
            <a href="{{ url_for('login') }}">Login</a>
            <a href="{{ url_for('signup') }}" class="btn-primary">Sign up</a>
          {% endif %}
        </div>
      </div>
    </nav>

    <main class="container">
      {% with messages = get_flashed_messages(with_categories=True) %}
        {% if messages %}
          {% for category, m in messages %}
            {% if category != 'contact' %}
              <div class="flash">{{ m }}</div>
            {% endif %}
          {% endfor %}
        {% endif %}
      {% endwith %}
      {% block content %}{% endblock %}
    </main>

    <footer>© {{ now().year }} SyntaxSnacks</footer>

    <script>
      function toggleMenu() {
        const links = document.getElementById('nav-links');
        const btn = document.querySelector('.menu-toggle');
        const open = links.classList.toggle('open');
        btn.setAttribute('aria-expanded', open ? 'true' : 'false');
      }

      function toggle(id) {
        const el = document.getElementById(id);
        if (!el) return;

        const hidden = window.getComputedStyle(el).display === 'none';
        el.style.display = hidden ? 'block' : 'none';
      }

      function toggleAdminMenu() {
        const menu = document.getElementById('admin-menu');
        const open = menu.classList.toggle('open');
        const btn = menu.querySelector('button');
        if (btn) btn.setAttribute('aria-expanded', open ? 'true' : 'false');
      }

      // --- JS sandbox via iframe (srcdoc; no DOM access; logs captured) ---
      function runJsSandbox(source, input) {
        return new Promise((resolve) => {
          const iframe = document.createElement('iframe');
          iframe.setAttribute('sandbox', 'allow-scripts');   // opaque origin; safe
          iframe.style.display = 'none';

          const html = `
    <!doctype html><meta charset="utf-8">
    <script>
    (function(){
      const results = [];
      function print(){ results.push(Array.from(arguments).join(' ')); }
      // Shadow console for this script execution
      const console = {
        log: (...args) => results.push(args.join(' ')),
        error: (...args) => results.push('ERROR: ' + args.join(' ')),
        warn: (...args) => results.push('WARN: ' + args.join(' '))
      };
      try {
        ${source}
        if (typeof solve === 'function') {
          const out = solve(${JSON.stringify(input)});
          if (out !== undefined) results.push(String(out));
        }
        parent.postMessage({ ok: true, out: results.join('\\n') }, '*');
      } catch (e) {
        parent.postMessage({ ok: false, out: (e && e.stack) ? e.stack : String(e) }, '*');
      }
    })();
    <\/script>`;

          // Prepare listener BEFORE attaching iframe
          const done = (payload) => {
            cleanup();
            resolve(payload || { ok:false, out:'No response' });
          };
          const onMsg = (ev) => done(ev.data);

          let timeout = setTimeout(() => done({ ok:false, out:'Execution timed out (5s).' }), 5000);

          function cleanup(){
            clearTimeout(timeout);
            window.removeEventListener('message', onMsg);
            if (document.body.contains(iframe)) iframe.remove();
          }

          window.addEventListener('message', onMsg);
          iframe.srcdoc = html;
          document.body.appendChild(iframe);
        });
      }

      // ---- Pyodide: robust runner using exec() without re-indenting user code ----
      let _pyReady = null, _pyodide = null;

      async function ensurePyodide() {
        if (_pyReady) return _pyReady;
        _pyReady = (async () => {
          const s = document.createElement('script');
          s.src = "https://cdn.jsdelivr.net/pyodide/v0.26.2/full/pyodide.js";
          document.head.appendChild(s);
          await new Promise(r => s.onload = r);
          _pyodide = await loadPyodide();   // stdlib (e.g., random) included
          return _pyodide;
        })();
        return _pyReady;
      }

      async function runPy(source, input) {
        await ensurePyodide();
        try {
          const py = `
    import sys, traceback
    _output = []

    def print(*args):
        _output.append(" ".join(str(a) for a in args))

    _user = {}
    # --- execute user program ---
    try:
        exec(${JSON.stringify(source)}, _user, _user)
    except Exception:
        _output.append(traceback.format_exc())

    # --- call solve(input) if provided ---
    try:
        if 'solve' in _user:
            res = _user['solve'](${JSON.stringify(input)})
            if res is not None:
                _output.append(str(res))
    except Exception:
        _output.append(traceback.format_exc())
    `;
          await _pyodide.runPythonAsync(py);
          const out = _pyodide.globals.get('_output').toJs().join('\n');
          return { ok: true, out };
        } catch (e) {
          return { ok: false, out: String(e) };
        }
      }

      // ---- TypeScript: transpile to JS and run in sandbox ----
      let _tsReady = null;

      async function ensureTypeScript() {
        if (_tsReady) return _tsReady;
        _tsReady = new Promise((resolve, reject) => {
          const s = document.createElement('script');
          s.src = "https://cdn.jsdelivr.net/npm/typescript@5.4.5/lib/typescript.min.js";
          s.onload = () => resolve(window.ts);
          s.onerror = () => reject(new Error('Failed to load TypeScript compiler.'));
          document.head.appendChild(s);
        });
        return _tsReady;
      }

      async function runTs(source, input) {
        try {
          const ts = await ensureTypeScript();
          const transpiled = ts.transpileModule(source, {
            compilerOptions: {
              target: ts.ScriptTarget.ES2020,
              module: ts.ModuleKind.ES2020
            }
          });
          return await runJsSandbox(transpiled.outputText, input);
        } catch (e) {
          return { ok: false, out: String(e) };
        }
      }

      // --- Wire the UI on pages that have the runner ---
      document.addEventListener('DOMContentLoaded', () => {
        const runBtn = document.getElementById('runBtn');
        if (!runBtn) return;
        const runner = document.getElementById('runner');
        const langSel = document.getElementById('lang');
        const code = document.getElementById('code');
        const inputEl = document.getElementById('input');
        const out = document.getElementById('output');
        const runnerNote = document.getElementById('runner-note');
        if (!langSel || !code || !out) return;

        const challengeLangRaw = runner && runner.dataset.challengeLang
          ? runner.dataset.challengeLang.trim()
          : '';

        const labels = {
          js: 'JavaScript',
          ts: 'TypeScript',
          py: 'Python',
          txt: 'Other (notes)'
        };

        const tokens = {
          js: ['javascript', 'js', 'node', 'nodejs', 'ecmascript'],
          ts: ['typescript', 'ts'],
          py: ['python', 'py']
        };

        const resolveChallengeLang = (raw) => {
          if (!raw) return { key: 'txt', reason: 'unspecified' };
          const normalized = raw.toLowerCase();
          const escapeRegex = (value) => value.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
          const tokenMatches = (text, token) => {
            const pattern = new RegExp(`(^|[^a-z0-9])${escapeRegex(token)}([^a-z0-9]|$)`);
            return pattern.test(text);
          };
          for (const key of Object.keys(tokens)) {
            if (tokens[key].some((t) => tokenMatches(normalized, t))) {
              return { key, reason: 'supported' };
            }
          }
          if (normalized.includes('general') || normalized.includes('any')) {
            return { key: 'txt', reason: 'unspecified' };
          }
          return { key: 'txt', reason: 'unsupported' };
        };

        const challengeLang = resolveChallengeLang(challengeLangRaw);

        const starter = {
          js: [
            '// Implement solve(input). Return a value to show it in Output.',
            'function solve(input) {',
            '  const text = String(input).trim();',
            "  return text.split('').reverse().join('');",
            '}'
          ].join('\n'),
          ts: [
            '// Implement solve(input). Return a value to show it in Output.',
            'function solve(input: string): string {',
            '  const text = String(input).trim();',
            "  return text.split('').reverse().join('');",
            '}'
          ].join('\n'),
          py: [
            '# Implement solve(input). Return a value to show it in Output.',
            'def solve(input):',
            '    text = str(input).strip()',
            '    return text[::-1]'
          ].join('\n'),
          txt: [
            'Notes mode: draft solutions in any language here.',
            'This mode does not execute code.'
          ].join('\n')
        };

        langSel.value = (challengeLang.key === 'txt') ? 'txt' : 'auto';

        const activeLangKey = () => {
          const selected = langSel.value || 'txt';
          return selected === 'auto' ? challengeLang.key : selected;
        };

        const applyMode = () => {
          const lang = activeLangKey();
          code.value = starter[lang] || '';
          const isScratch = lang === 'txt';
          runBtn.disabled = isScratch;
          if (runnerNote) {
            let note = '';
            if (langSel.value === 'auto') {
              if (!challengeLangRaw) {
                note = 'No challenge language specified. Pick a runnable language to execute.';
              } else if (isScratch) {
                note = `Challenge language: ${challengeLangRaw} isn't runnable in the browser. Notes mode is active.`;
              } else {
                note = `Auto: ${labels[lang]} (challenge language: ${challengeLangRaw}).`;
              }
            } else if (isScratch) {
              if (challengeLang.reason === 'unsupported' && challengeLangRaw) {
                note = `Challenge language: ${challengeLangRaw} isn't runnable in the browser. Notes mode is active.`;
              } else if (challengeLang.reason === 'unspecified') {
                note = challengeLangRaw
                  ? `Challenge language: ${challengeLangRaw}. Pick a runnable language to execute.`
                  : 'No challenge language specified. Pick a runnable language to execute.';
              } else {
                note = 'Notes mode: no runner available.';
              }
            } else {
              note = 'Input is passed to solve(input). Return a value or use print()/console.log() to show output.';
            }
            runnerNote.textContent = note;
          }
          if (isScratch) {
            out.textContent = 'Use this editor to draft solutions in any language and compare with the solution.';
            out.className = 'card';
          } else {
            out.textContent = '';
            out.className = 'card';
          }
        };
        applyMode();
        langSel.addEventListener('change', applyMode);

        runBtn.addEventListener('click', async () => {
          const lang = activeLangKey();
          if (lang === 'txt') return;
          out.textContent = 'Running...';
          const sampleInput = inputEl ? inputEl.value : '';
          let result;
          if (lang === 'js') {
            result = await runJsSandbox(code.value, sampleInput);
          } else if (lang === 'ts') {
            result = await runTs(code.value, sampleInput);
          } else {
            result = await runPy(code.value, sampleInput);
          }

          let outputText = result.out || '';
          if (!outputText) {
            outputText = result.ok
              ? 'No output. Return a value from solve(input) or use print()/console.log().'
              : 'Error with no message';
          }
          if (!result.ok && outputText.includes('Execution timed out')) {
            outputText = 'Execution timed out (5s). Check for infinite loops or heavy work.';
          }
          out.textContent = outputText;
          out.className = 'card ' + (result.ok ? 'ok' : 'err');
        });

        code.addEventListener('keydown', (event) => {
          if (event.key !== 'Tab') return;
          event.preventDefault();
          const start = code.selectionStart;
          const end = code.selectionEnd;
          const insert = '  ';
          code.value = code.value.substring(0, start) + insert + code.value.substring(end);
          code.selectionStart = code.selectionEnd = start + insert.length;
        });
      });
    </script>


    <script src="{{ url_for('static', filename='js/templatemo-glossy-touch.js') }}"></script>
  </body>
</html>

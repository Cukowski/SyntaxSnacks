<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SyntaxSnacks</title>
    <link rel="icon" href="{{ url_for('static', filename='images/logo.png') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/templatemo-glossy-touch.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/custom.css') }}" />
  </head>
  <body>

    <!-- Navbar -->
    <nav class="navbar">
      <div class="nav-inner">
        <div class="brand">
          <a class="brand-link" href="{{ url_for('index') }}">
            <img class="logo" src="{{ url_for('static', filename='images/logo.png') }}" alt="SyntaxSnacks logo" />
            <span>SyntaxSnacks</span>
          </a>
        </div>

        <!-- Mobile hamburger -->
        <button class="menu-toggle" aria-label="Toggle menu" aria-expanded="false" onclick="toggleMenu()">
          <span></span><span></span><span></span>
        </button>

        <!-- Links -->
        <div id="nav-links" class="links">
          <a href="{{ url_for('index') }}" class="{{ 'active' if request.endpoint=='index' else '' }}">Home</a>
          <a href="{{ url_for('dashboard') }}" class="{{ 'active' if request.endpoint=='dashboard' else '' }}">Dashboard</a>
          <a href="{{ url_for('dungeons_list') }}" class="{{ 'active' if request.endpoint in ['dungeons_list', 'dungeon_view'] else '' }}">Explorer</a>
          <a href="{{ url_for('puzzles_hub') }}" class="{{ 'active' if request.endpoint.startswith('puzzle') else '' }}">Puzzles</a>
          <a href="{{ url_for('leaderboard') }}" class="{{ 'active' if request.endpoint=='leaderboard' else '' }}">Leaderboard</a>
          <a href="{{ url_for('about') }}" class="{{ 'active' if request.endpoint=='about' else '' }}">About</a>
          <a href="{{ url_for('contact') }}" class="{{ 'active' if request.endpoint=='contact' else '' }}">Contact</a>

          {% if current_user.is_authenticated %}
            {% if current_user.is_admin %}
              <a href="{{ url_for('admin_add_challenge') }}">Admin</a>
              <a href="{{ url_for('admin_messages') }}">Inbox</a>
            {% endif %}
            <a href="{{ url_for('logout') }}">Logout</a>
          {% else %}
            <a href="{{ url_for('login') }}">Login</a>
            <a href="{{ url_for('signup') }}" class="btn-primary">Sign up</a>
          {% endif %}
        </div>
      </div>
    </nav>

    <main class="container">
      {% with messages = get_flashed_messages(with_categories=True) %}
        {% if messages %}
          {% for category, m in messages %}
            {% if category != 'contact' %}
              <div class="flash">{{ m }}</div>
            {% endif %}
          {% endfor %}
        {% endif %}
      {% endwith %}
      {% block content %}{% endblock %}
    </main>

    <footer>Â© {{ now().year }} SyntaxSnacks</footer>

    <script>
      function toggleMenu() {
        const links = document.getElementById('nav-links');
        const btn = document.querySelector('.menu-toggle');
        const open = links.classList.toggle('open');
        btn.setAttribute('aria-expanded', open ? 'true' : 'false');
      }

      function toggle(id) {
        const el = document.getElementById(id);
        if (!el) return;

        const hidden = window.getComputedStyle(el).display === 'none';
        el.style.display = hidden ? 'block' : 'none';
      }

      // --- JS sandbox via iframe (srcdoc; no DOM access; logs captured) ---
      function runJsSandbox(source, input) {
        return new Promise((resolve) => {
          const iframe = document.createElement('iframe');
          iframe.setAttribute('sandbox', 'allow-scripts');   // opaque origin; safe
          iframe.style.display = 'none';

          const html = `
    <!doctype html><meta charset="utf-8">
    <script>
    (function(){
      const results = [];
      function print(){ results.push(Array.from(arguments).join(' ')); }
      // Shadow console for this script execution
      const console = {
        log: (...args) => results.push(args.join(' ')),
        error: (...args) => results.push('ERROR: ' + args.join(' ')),
        warn: (...args) => results.push('WARN: ' + args.join(' '))
      };
      try {
        ${source}
        if (typeof solve === 'function') {
          const out = solve(${JSON.stringify(input)});
          if (out !== undefined) results.push(String(out));
        }
        parent.postMessage({ ok: true, out: results.join('\\n') }, '*');
      } catch (e) {
        parent.postMessage({ ok: false, out: (e && e.stack) ? e.stack : String(e) }, '*');
      }
    })();
    <\/script>`;

          // Prepare listener BEFORE attaching iframe
          const done = (payload) => {
            cleanup();
            resolve(payload || { ok:false, out:'No response' });
          };
          const onMsg = (ev) => done(ev.data);

          let timeout = setTimeout(() => done({ ok:false, out:'Execution timed out.' }), 5000);

          function cleanup(){
            clearTimeout(timeout);
            window.removeEventListener('message', onMsg);
            if (document.body.contains(iframe)) iframe.remove();
          }

          window.addEventListener('message', onMsg);
          iframe.srcdoc = html;
          document.body.appendChild(iframe);
        });
      }

      // ---- Pyodide: robust runner using exec() without re-indenting user code ----
      let _pyReady = null, _pyodide = null;

      async function ensurePyodide() {
        if (_pyReady) return _pyReady;
        _pyReady = (async () => {
          const s = document.createElement('script');
          s.src = "https://cdn.jsdelivr.net/pyodide/v0.26.2/full/pyodide.js";
          document.head.appendChild(s);
          await new Promise(r => s.onload = r);
          _pyodide = await loadPyodide();   // stdlib (e.g., random) included
          return _pyodide;
        })();
        return _pyReady;
      }

      async function runPy(source, input) {
        await ensurePyodide();
        try {
          const py = `
    import sys, traceback
    _output = []

    def print(*args):
        _output.append(" ".join(str(a) for a in args))

    _user = {}
    # --- execute user program ---
    try:
        exec(${JSON.stringify(source)}, _user, _user)
    except Exception:
        _output.append(traceback.format_exc())

    # --- call solve(input) if provided ---
    try:
        if 'solve' in _user:
            res = _user['solve'](${JSON.stringify(input)})
            if res is not None:
                _output.append(str(res))
    except Exception:
        _output.append(traceback.format_exc())
    `;
          await _pyodide.runPythonAsync(py);
          const out = _pyodide.globals.get('_output').toJs().join('\n');
          return { ok: true, out };
        } catch (e) {
          return { ok: false, out: String(e) };
        }
      }

      // --- Wire the UI on pages that have the runner ---
      document.addEventListener('DOMContentLoaded', () => {
        const runBtn = document.getElementById('runBtn');
        if (!runBtn) return;
        const langSel = document.getElementById('lang');
        const code = document.getElementById('code');
        const out = document.getElementById('output');

        const starter = {
          js: `// Write a function solve(input) and return the result
    function solve(input){
      // example: reverse string
      return String(input).split('').reverse().join('');
    }
    // You can also use print('hello') to append output`,
          py: `# Write a function solve(input) and return the result
    def solve(input):
        # example: reverse string
        return str(input)[::-1]
    # You can also print("hello") to append output`
        };
        code.value = starter[langSel.value];
        langSel.addEventListener('change', () => { code.value = starter[langSel.value]; });

        runBtn.addEventListener('click', async () => {
          out.textContent = 'Running...';
          const sampleInput = 'hello';
          let result = (langSel.value === 'js')
            ? await runJsSandbox(code.value, sampleInput)
            : await runPy(code.value, sampleInput);

          out.textContent = result.out || (result.ok ? '(no output)' : 'Error with no message');
          out.className = 'card ' + (result.ok ? 'ok' : 'err');
        });
      });
    </script>


    <script src="{{ url_for('static', filename='js/templatemo-glossy-touch.js') }}"></script>
  </body>
</html>

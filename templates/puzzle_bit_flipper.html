{% extends 'base.html' %}
{% block content %}
<style>
  .bit-flipper { text-align: center; max-width: 780px; margin: 0 auto; }
  .switch-container {
    display: flex; justify-content: center; gap: 12px 14px;
    margin: 20px auto; flex-wrap: wrap;
  }
  .switch-wrapper { display: flex; flex-direction: column; align-items: center; flex: 0 0 72px; }
  .switch {
    width: 54px; height: 86px; background-color: #334; border: 2px solid #556;
    border-radius: 10px; cursor: pointer; position: relative;
    transition: background-color 0.2s;
  }
  .switch .handle {
    width: 40px; height: 36px; background-color: #889; border-radius: 6px;
    position: absolute; left: 50%; transform: translateX(-50%);
    transition: top 0.2s ease-out;
  }
  .switch.on { background-color: #45f0c8; border-color: #fff; }
  .switch.on .handle { background-color: #fff; }
  .switch.off .handle { top: 40px; }
  .switch.on .handle { top: 5px; }
  .bit-value { font-size: 0.8em; color: #aaa; margin-top: 5px; }
  #result-display { font-size: 1.5em; font-weight: bold; font-family: monospace; }
  #feedback { height: 24px; margin-top: 10px; font-weight: bold; }
  #feedback.correct { color: #45f0c8; }
  #feedback.incorrect { color: #ff6b6b; }
  #completion-actions .completion-message { margin-bottom: 10px; }
  #completion-actions .btn { display: inline-block; } /* Ensure button has block properties for margin */

  @media (max-width: 520px) {
    .switch { width: 46px; height: 76px; }
    .switch .handle { width: 34px; height: 32px; }
    .switch-wrapper { flex: 0 0 64px; }
    .bit-value { font-size: 0.75em; }
  }
</style>

<div class="glass puzzle-shell">
  <a href="{{ url_for('puzzles_hub') }}">&larr; Back to Puzzle Arcade</a>
  <div class="bit-flipper">
    <h2 style="margin-top: 12px;">{{ title }} (Level {{ level }}/{{ total_levels }})</h2>
    <p>Click the switches to represent the decimal number <strong>{{ target }}</strong> in binary.</p>

    <div class="switch-container">
      {% for i in range(8) %}
      <div class="switch-wrapper">
        <div class="switch off" data-value="{{ 2**(7-i) }}">
          <div class="handle"></div>
        </div>
        <div class="bit-value">{{ 2**(7-i) }}</div>
      </div>
      {% endfor %}
    </div>

    <div>
      Current Value: <span id="result-display">0</span>
    </div>
    <div id="feedback"></div>
    <div id="completion-actions" style="margin-top: 10px;">
      {% if is_completed %}
        <p class="completion-message" style="color: #45f0c8; font-weight: bold;">You have already completed this puzzle!</p>
        {% if level < total_levels %}
          <div>
            <a href="{{ url_for('puzzle_bit_flipper', level_num=level + 1) }}" class="btn">Next Level &rarr;</a>
          </div>
        {% endif %}
      {% endif %}
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const switches = document.querySelectorAll('.switch');
  const resultDisplay = document.getElementById('result-display');
  const feedback = document.getElementById('feedback');
  const targetNumber = {{ target }};
  const isCompleted = {{ is_completed|tojson }};
  let isLocked = isCompleted;

  function updateValue() {
    let currentValue = 0;
    switches.forEach(s => {
      if (s.classList.contains('on')) {
        currentValue += parseInt(s.dataset.value, 10);
      }
    });
    resultDisplay.textContent = currentValue;
    checkAnswer(currentValue);
  }

  function checkAnswer(value) {
    if (value === targetNumber) {
      feedback.textContent = 'Correct! +{{ xp_reward }} XP';
      feedback.className = 'correct';
      if (!isLocked) {
        isLocked = true; // Prevent multiple submissions
        awardXp();

        // Show 'Next Level' button if applicable
        const nextLevel = {{ level + 1 }};
        if (nextLevel <= {{ total_levels }}) {
          const completionDiv = document.getElementById('completion-actions');
          const nextLevelDiv = document.createElement('div');
          nextLevelDiv.innerHTML = `<a href="{{ url_for('puzzle_bit_flipper', level_num=level + 1) }}" class="btn">Next Level &rarr;</a>`;
          completionDiv.appendChild(nextLevelDiv);
        }
      }
    } else {
      feedback.textContent = 'Keep trying...';
      feedback.className = 'incorrect';
    }
  }

  async function awardXp() {
    try {
      const response = await fetch("{{ url_for('complete_puzzle') }}", {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ puzzle_name: '{{ puzzle_name }}' })
      });
      if (!response.ok) throw new Error('Failed to award XP');
    } catch (error) {
      console.error(error);
      feedback.textContent = 'Correct! (But failed to save XP)';
    }
  }

  switches.forEach(s => {
    s.addEventListener('click', () => {
      if (isLocked) return;
      s.classList.toggle('on');
      s.classList.toggle('off');
      updateValue();
    });
  });
});
</script>
{% endblock %}
